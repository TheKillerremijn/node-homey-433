<link href="../../../assets/433_generator/css/svgstyle.css" rel="stylesheet" type="text/css"/>
<script src="../../../assets/433_generator/js/svghighlighter.js" type="text/javascript"></script>

<div>
	<div id="dipswitch-container">
		<div id="dipswitch" class="group"></div>
	</div>
	<div id="body"><span class="content"></span></div>
</div>

<script>
	var $container = $('[data-id="' + options.id + '"] ');
	$container.find('#body > span').html(__(options.body));
	var $dipswitchContainer = $container.find('#dipswitch-container');
	var $dipswitchElem = $dipswitchContainer.find('#dipswitch');

	if (!$container.find('.view-navigation-next.dummy').length) {
		var $nextButton = $container.find('.view-navigation-next');
		var $nextButtonDummy = $nextButton.clone().addClass('dummy');
		$nextButton.hide();
		$nextButton.parent().append($nextButtonDummy);

		$nextButtonDummy.on('click', function (e) {
			Homey.emit('assert_device', function (err, device) {
				if (err){
					Homey.alert(__(err.message || err));
					return;
				}
				window.selected_devices = [device.data.id];
				window.found_devices = {};
				window.found_devices[device.data.id] = device;
				$nextButtonDummy.siblings('.view-navigation-next').click();
			});
			e.stopPropagation();
			return false;
		});
	}

	generateDipswitches(options.dipswitchList, $dipswitchElem, false);

	Homey.emit('get_device', function (err, device) {
		console.log('got device', device);
		if (device && device.data && device.data.dipswitches) {
			setDipswitchArray(device.data.dipswitches, $dipswitchElem);
		} else {
			Homey.emit('set_device_dipswitches', getDipswitchArray($dipswitchElem));
		}
	});

	function generateDipswitches(dipswitchList, elem, connected) {
		dipswitchList.forEach(function (symbol, index) {
			if (Array.isArray(symbol)) {
				var group = $('<div>').addClass('group' + (!connected ? ' connected' : ''));
				generateDipswitches(symbol, group, !connected);
				elem.append(group);
			} else {
				elem.append(
					$('<div>').addClass('item').append(
						$('<span>').addClass('switch' + (connected && index === 0 ? ' on' : '')).append(
							$('<span>').addClass('knob')
						).click(function () {
							if ($(this).parent().parent().is('.group.connected')) {
								$(this).parent().siblings('.item').find('.switch').removeClass('on');
								$(this).addClass('on');
							} else {
								$(this).toggleClass('on');
							}
							Homey.emit('set_device_dipswitches', getDipswitchArray($dipswitchElem));
						}),
						$('<span>').addClass('symbol').html(symbol)
					)
				);
			}
		});
	}

	function getDipswitchArray(elem) {
		var result = [];
		elem.children().each(function () {
			if ($(this).is('.item')) {
				result.push($(this).find('.switch').hasClass('on'))
			} else if ($(this).is('.group')) {
				result.push(getDipswitchArray($(this)));
			}
		});
		return result;
	}

	function setDipswitchArray(dipswitches, elem) {
		var $items = elem.children('.item');
		var $groups = elem.children('.group');
		dipswitches.forEach(function (state) {
			if (Array.isArray(state)) {
				var $groupElem = $($groups.splice(0, 1)[0]);
				if ($groupElem.length) {
					setDipswitchArray(state, $groupElem);
				}
			} else {
				var $switchElem = $($items.splice(0, 1)[0]).find('.switch');
				if ($switchElem.length) {
					if (state) {
						$switchElem.addClass('on');
					} else {
						$switchElem.removeClass('on');
					}
				}
			}
		});
	}
</script>

<style>
	#body {
		position: absolute;
		bottom: 0;
		height: 20vh;
		text-align: center;
		font-size: 4vh;
		width: 100%;
	}

	#dipswitch-container {
		display: flex;
		align-items: center;
		justify-content: center;
		margin: auto;
		height: 70vh;
		width: 80vw;
		font-size: 4vw;
	}

	#dipswitch {
		display: inline-block;
		background: #ff1000;
		overflow: hidden;
		border-radius: 0.11em;
		padding: 0.32em;
		box-shadow: inset 0 -0.24em 1em rgba(0, 0, 0, 0.25);
	}

	#dipswitch .group {
		float: left;
	}

	#dipswitch .item {
		float: left;
		width: 1.25em;
		margin-right: 0.314em;
	}

	#dipswitch .item:last-child {
		margin-right: 0;
	}

	#dipswitch .symbol {
		text-align: center;
		color: white;
		font-family: sans-serif;
		display: block;
		font-size: 0.75em;
		line-height: 1.25em;
		margin-top: 0.25em;
		text-shadow: 0 0.125em 0.0625em rgba(0, 0, 0, 0.1);
	}

	#dipswitch .switch {
		display: block;
		position: relative;
		background: #eee;
		overflow: hidden;
		cursor: pointer;
		width: 1.25em;
		height: 2.5em;
		border-radius: 0.125em;
		box-shadow: inset 0 0 0.3175em rgba(0, 0, 0, 0.4);
	}

	#dipswitch .switch .knob {
		position: absolute;
		top: 50%;
		left: 0;
		width: 100%;
		height: 50%;
		background: white;
		box-shadow: inset 0 0 0.31em rgba(0, 0, 0, 0.2), 0 -0.31em 1.25em rgba(0, 0, 0, 0.3);
		border-radius: 0.1875em;
		transition: all 0.2s;
	}

	#dipswitch .switch:hover .knob {
		box-shadow: inset 0 0 0.31em rgba(0, 0, 0, 0.2), 0 -0.31em 1.25em rgba(0, 0, 0, 0.6);
	}

	#dipswitch .switch.on .knob {
		top: 0;
		box-shadow: inset 0 0 0.31em rgba(0, 0, 0, 0.2), 0 0.31em 1.25em rgba(0, 0, 0, 0.3);
	}

	#dipswitch .switch.on:hover .knob {
		box-shadow: inset 0 0 0.31em rgba(0, 0, 0, 0.2), 0 0.31em 1.25em rgba(0, 0, 0, 0.6);
	}
</style>